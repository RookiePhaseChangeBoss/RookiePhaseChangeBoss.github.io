---
title: "Docker æ€§èƒ½åˆ†æ"
date: 2026-01-15 11:55:00 +0800
categories: [Docker, æ€§èƒ½åˆ†æ]   # åˆ†ç±» (æ”¯æŒå¤šçº§) 
tags: [Docker, System]               				# æ ‡ç­¾ (ä¸é™æ•°é‡) 
description: "Linux ç³»ç»Ÿæ€§èƒ½åˆ†æé€’è¿›åˆ° Docker æ€§èƒ½åˆ†æ"
author: "YoungZhongque"
pin: false                             		# æ˜¯å¦ç½®é¡¶ (true / false) 

# å°é¢å›¾ (ç¤¾äº¤åª’ä½“é¢„è§ˆå›¾æœ€ä½³å°ºå¯¸ 1200x630) 
# image:
  # path: /assets/img/sample-cover.jpg     # ç«™ç‚¹å†…è·¯å¾„
  # alt: "å°é¢å›¾æè¿°"
  # lqip: /assets/img/lqip/sample.jpg      #  (å¯é€‰) ä½è´¨é‡å ä½å›¾

# æ˜¯å¦å¯ç”¨ç›®å½• (å·¦ä¾§æµ®åŠ¨ç›®å½•) 
toc: true
toc_label: "ç›®å½•"
toc_icon: "list-ul"

# æ–‡ç« ç‰ˆæƒ / è½¬è½½å£°æ˜ (å¯é€‰) 
copyright:
  license: CC BY-NC-SA 4.0
  holder: "YoungZhongque"
---



> <font color = 'red'>æœªæ›´æ–°å®Œ</font> 

# 1. Docker å®¹å™¨æ€§èƒ½ç›‘æ§çš„åˆ†å±‚è®¤çŸ¥

åœ¨è®²å·¥å…·ä¹‹å‰ï¼Œå…ˆæ˜ç¡®ä¸€ä¸ª**å…³é”®å‰æ**ï¼š

> **å®¹å™¨æ€§èƒ½ â‰  ä¸»æœºæ€§èƒ½**

å®¹å™¨çš„èµ„æºç»Ÿè®¡ï¼Œ**æœ¬è´¨æ¥è‡ª Linux cgroup + namespace**ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„ `top / vmstat / iostat`ã€‚

ç›‘æ§èƒ½åŠ›å¯åˆ†ä¸º 4 å±‚ï¼š

| å±‚çº§ | èƒ½çœ‹åˆ°ä»€ä¹ˆ      | å…¸å‹å·¥å…·             |
| ---- | --------------- | -------------------- |
| L0   | å®¹å™¨èµ„æºæ±‡æ€»    | docker stats         |
| L1   | cgroup ç²¾ç»†æŒ‡æ ‡ | cAdvisor             |
| L2   | å†å² + å¯è§†åŒ–   | Prometheus + Grafana |
| L3   | ç³»ç»Ÿè°ƒç”¨ / è¡Œä¸º | Sysdig / eBPF        |
| L4   | åº”ç”¨æŒ‡æ ‡        | åº”ç”¨è‡ªèº«åŸ‹ç‚¹         |

ä½ ç»™çš„æ–¹æ¡ˆåŸºæœ¬è¦†ç›– **L0 â†’ L3**ï¼Œéå¸¸å®Œæ•´ã€‚

------

# 2. docker stats â€”â€” å®¹å™¨ç›‘æ§çš„â€œå…¥å£å·¥å…·â€

## 2.1. åŸç†

`docker stats` **ç›´æ¥è¯»å– Docker Engine ç»´æŠ¤çš„ cgroup ç»Ÿè®¡ä¿¡æ¯**ï¼š

- `/sys/fs/cgroup/cpu/docker/<id>/`
- `/sys/fs/cgroup/memory/docker/<id>/`

å¹¶åšä¸€æ¬¡ç®€å•èšåˆå±•ç¤ºã€‚

## 2.2. èƒ½çœ‹ä»€ä¹ˆ

```bash
docker stats --no-stream
```

| æŒ‡æ ‡      | è¯´æ˜                          |
| --------- | ----------------------------- |
| CPU %     | å®¹å™¨ CPU ä½¿ç”¨ç‡ï¼ˆå·²è€ƒè™‘å¤šæ ¸ï¼‰ |
| MEM USAGE | å½“å‰å†…å­˜ / é™åˆ¶               |
| NET I/O   | ç½‘ç»œæ”¶å‘                      |
| BLOCK I/O | ç£ç›˜è¯»å†™                      |

âš ï¸ **CPU% è®¡ç®—æ–¹å¼**

> å®¹å™¨ CPU æ—¶é—´ / å®¿ä¸»æ€» CPU æ—¶é—´
> æ‰€ä»¥å¤šæ ¸æœºå™¨ä¸Šå¯èƒ½ >100%

## 2.3. é€‚ç”¨åœºæ™¯

âœ… æœ¬åœ°è°ƒè¯•
âœ… ä¸´æ—¶æ’æŸ¥â€œå“ªä¸ªå®¹å™¨åƒèµ„æºâ€
âŒ ä¸é€‚åˆçº¿ä¸Šé•¿æœŸç›‘æ§

## 2.4. æ˜ç¡®çš„å±€é™

- âŒ æ— å†å²
- âŒ æ— å‘Šè­¦
- âŒ æ—  per-processï¼ˆçœ‹ä¸åˆ°å®¹å™¨å†…éƒ¨è¿›ç¨‹ï¼‰

ğŸ‘‰ **ç»“è®º**ï¼šåªèƒ½ä½œä¸ºâ€œç¬¬ä¸€çœ¼å·¥å…·â€

------

# 3. cAdvisor â€”â€” Docker å®¹å™¨ç›‘æ§çš„äº‹å®æ ‡å‡†

## 3.1. cAdvisor æ˜¯ä»€ä¹ˆ

Google å¼€æºçš„ **Container Advisor**ï¼š

> ä¸“é—¨ä» **cgroup + fs + netns** é‡‡é›†å®¹å™¨çº§åˆ«èµ„æºæŒ‡æ ‡

Kubernetes æ—©æœŸç‰ˆæœ¬ **å†…ç½®å°±æ˜¯ cAdvisor**ã€‚

------

## 3.2. å¯åŠ¨å‚æ•°ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼ˆé‡ç‚¹ï¼‰

```bash
docker run -d \
  --name cadvisor \
  --privileged \
  --volume /:/rootfs:ro \
  --volume /var/run:/var/run:ro \
  --volume /sys:/sys:ro \
  --volume /var/lib/docker/:/var/lib/docker:ro \
  --publish 8080:8080 \
  gcr.io/cadvisor/cadvisor:latest
```

é€é¡¹è§£é‡Šï¼ˆéå¸¸å…³é”®ï¼‰ï¼š

| å‚æ•°              | ä½œç”¨                 |
| ----------------- | -------------------- |
| `--privileged`    | è¯»å– cgroup / proc   |
| `/sys`            | CPU / memory / blkio |
| `/var/lib/docker` | å®¹å™¨å…ƒæ•°æ®           |
| `/var/run`        | docker.sock          |
| `/`               | æ–‡ä»¶ç³»ç»Ÿå®¹é‡ç»Ÿè®¡     |

âš ï¸ **è¿™æ˜¯â€œåªè¯»æŒ‚è½½â€ï¼Œé£é™©å¯æ§**

------

## 3.3. èƒ½çœ‹åˆ°å“ªäº›æ ¸å¿ƒæŒ‡æ ‡

CPU

- ä½¿ç”¨ç‡ï¼ˆæŒ‰æ ¸ï¼‰
- throttlingï¼ˆæ˜¯å¦è¢«é™é€Ÿï¼‰

å†…å­˜

- RSS
- Cache
- Limit
- **OOM Kill æ¬¡æ•°ï¼ˆéå¸¸é‡è¦ï¼‰**

ç½‘ç»œ

- rx / tx bytes
- packets / drops

ç£ç›˜

- read/write bytes
- IOPS

## 3.4. cAdvisor çš„å®šä½

| èƒ½                | ä¸èƒ½         |
| ----------------- | ------------ |
| ç²¾ç¡®å®¹å™¨èµ„æº      | åº”ç”¨ QPS     |
| Prometheus Export | å»¶è¿Ÿã€é”™è¯¯ç‡ |
| OOM è¯Šæ–­          | ä¸šåŠ¡ SLA     |

ğŸ‘‰ **ç»“è®º**ï¼š**èµ„æºå±‚æœ€ä¼˜è§£**

------

# 4. Prometheus + Grafana â€”â€” ç”Ÿäº§çº§å¿…é€‰

## 4.1. å…¸å‹æ¶æ„

```
[cAdvisor] ---> [Prometheus] ---> [Grafana]
```

- cAdvisorï¼šé‡‡é›†
- Prometheusï¼šå­˜å‚¨ + æŸ¥è¯¢
- Grafanaï¼šå¯è§†åŒ– + å‘Šè­¦

------

## 4.2. å…³é”®æŒ‡æ ‡ç¤ºä¾‹ï¼ˆPromQLï¼‰

```promql
# å®¹å™¨ CPU ä½¿ç”¨ç‡
rate(container_cpu_usage_seconds_total[5m])

# å®¹å™¨å†…å­˜ä½¿ç”¨
container_memory_working_set_bytes

# OOM æ¬¡æ•°
container_oom_events_total
```

------

## 4.3. ä¸ºä»€ä¹ˆè¿™æ˜¯â€œç”Ÿäº§æ–¹æ¡ˆâ€

âœ… æœ‰å†å²
âœ… å¯å‘Šè­¦
âœ… å¯å®¹é‡è§„åˆ’
âœ… å¯åš SLO / è¶‹åŠ¿åˆ†æ



# 5. Sysdig / Falco â€”â€” è¡Œä¸ºçº§ã€å†…æ ¸çº§åˆ†æ

## 5.1. Sysdig åœ¨çœ‹ä»€ä¹ˆ

å®ƒä¸æ˜¯â€œèµ„æºç›‘æ§â€ï¼Œè€Œæ˜¯ï¼š

> **ç³»ç»Ÿè°ƒç”¨çº§åˆ«çš„è¡Œä¸ºåˆ†æ**

åŸºäºï¼š

- å†…æ ¸æ¨¡å—ï¼ˆæ—§ï¼‰
- **eBPFï¼ˆæ–°ï¼‰**

------

## 5.2. ç¤ºä¾‹å‘½ä»¤çš„å«ä¹‰

```bash
sysdig -pc cont.id=abc123 and evt.type in (open,read,write,connect)
```

= åªçœ‹æŸä¸ªå®¹å™¨çš„ï¼š

- æ–‡ä»¶æ‰“å¼€
- IO è¯»å†™
- ç½‘ç»œè¿æ¥

------

## 5.3. é€‚ç”¨åœºæ™¯ï¼ˆéå¸¸æ˜ç¡®ï¼‰

âœ… å®¹å™¨å¼‚å¸¸è¡Œä¸º
âœ… å®‰å…¨å®¡è®¡
âœ… â€œå®¹å™¨ä¸ºä»€ä¹ˆçªç„¶å¡æ­»â€

âŒ æ—¥å¸¸èµ„æºç›‘æ§

# 6. ctop â€”â€” äººç±»å‹å¥½çš„å®æ—¶å·¥å…·

## 6.1. æœ¬è´¨

- åŸºäº Docker API
- ç±»ä¼¼ `htop`ï¼Œä½†å¯¹è±¡æ˜¯ **container**

## 6.2. ç‰¹ç‚¹

| ä¼˜ç‚¹     | ç¼ºç‚¹       |
| -------- | ---------- |
| å®æ—¶äº¤äº’ | æ— å†å²     |
| å¿«é€Ÿå®šä½ | ä¸é€‚åˆçº¿ä¸Š |
| äººæ€§åŒ–   | åªæ˜¯ UI    |

ğŸ‘‰ **ç»“è®º**ï¼šå¼€å‘ / è¿ç»´çš„â€œå¢å¼ºç‰ˆ docker statsâ€



# 7. Docker ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆç”Ÿäº§å¿…é…ï¼‰

## 7.1. å®˜æ–¹æ¨èæ–¹å¼ï¼ˆdaemon.jsonï¼‰

ç¼–è¾‘ï¼š

```bash
sudo mkdir -p /etc/docker
sudo vim /etc/docker/daemon.json
```

æ¨èé…ç½®ï¼ˆç¨³å®šï¼‰

```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://mirror.ccs.tencentyun.com",
    "https://hub-mirror.c.163.com"
  ],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  }
}
```

é‡å¯ Dockerï¼š

```bash
sudo systemctl daemon-reexec
sudo systemctl restart docker
```

------

## 7.2. éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ

```bash
docker info | grep -A 5 "Registry Mirrors"
```

------

## 7.3. é‡è¦è¯´æ˜ï¼ˆç°å®æƒ…å†µï¼‰

| é•œåƒæº | ç°çŠ¶   |
| ------ | ------ |
| é˜¿é‡Œäº‘ | éœ€ç™»å½• |
| ä¸­ç§‘å¤§ | ç¨³å®š   |
| è…¾è®¯äº‘ | ç¨³å®š   |
| ç½‘æ˜“   | ç¨³å®š   |

âš ï¸ **gcr.io é•œåƒ**ï¼ˆå¦‚ cAdvisorï¼‰
å»ºè®®ï¼š

```bash
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/cadvisor:v0.49.1
```